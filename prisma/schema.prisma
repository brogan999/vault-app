// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

enum SubscriptionTier {
  free
  pro
}

enum DocumentType {
  pdf
  audio
  text
  image
}

enum DocumentCategory {
  cognitive
  esoteric
  journal
  psyche
}

model User {
  id              String          @id @default(uuid())
  clerkId         String          @unique
  email           String
  subscriptionTier SubscriptionTier @default(free)
  themePreference String?         @default("neutral")
  privacyShieldEnabled Boolean     @default(false)
  personaPreference String?       @default("balanced")
  consentedAt     DateTime?
  birthDate       DateTime?       // date of birth for esoteric frameworks
  birthTime       String?         // "HH:mm" or null if unknown
  birthLocationLat Float?
  birthLocationLng Float?
  birthLocationName String?
  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @updatedAt

  psychProfile    PsychProfile?
  documents       Document[]
  embeddings      Embedding[]
  chatSessions    ChatSession[]
  purchases       Purchase[]

  @@map("users")
}

model Purchase {
  id              String   @id @default(uuid())
  userId          String
  user            User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  stripeSessionId String   @unique
  priceId         String
  productName     String
  amountPaid      Int      // cents
  currency        String   @default("usd")
  status          String   @default("completed") // completed, refunded
  fulfilledAt     DateTime?
  
  createdAt       DateTime @default(now())

  @@index([userId])
  @@map("purchases")
}

model PsychProfileSnapshot {
  id            String   @id @default(uuid())
  userId        String
  big5Scores    Json?
  astrologyMeta Json?
  iqScore       Int?
  source        String   @default("manual") // manual, ai_inferred
  createdAt     DateTime @default(now())

  @@index([userId])
  @@index([createdAt])
  @@map("psychProfileSnapshots")
}

model PsychProfile {
  id            String   @id @default(uuid())
  userId        String   @unique
  user          User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  big5Scores    Json?    // { openness: 80, conscientiousness: 75, ... }
  astrologyMeta Json?    // { sun: "scorpio", moon: "aries", ... }
  iqScore       Int?
  
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@map("psychProfile")
}

model Document {
  id          String          @id @default(uuid())
  userId      String
  user        User            @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  fileUrl     String
  fileName    String
  type        DocumentType
  category    DocumentCategory
  contentText String?
  metadata    Json?
  
  status      String          @default("pending") // pending, processing, completed, error
  
  createdAt   DateTime        @default(now())
  updatedAt   DateTime        @updatedAt
  
  embeddings  Embedding[]
  
  @@index([userId])
  @@index([category])
  @@map("documents")
}

model Embedding {
  id          String   @id @default(uuid())
  documentId String
  document   Document @relation(fields: [documentId], references: [id], onDelete: Cascade)
  userId     String
  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  contentChunk String
  embedding    Unsupported("vector(1536)")? // pgvector type
  
  createdAt    DateTime @default(now())
  
  @@index([userId])
  @@index([documentId])
  @@map("Embedding")
}

model ChatSession {
  id        String   @id @default(uuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  title     String?
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  messages  Message[]
  
  @@index([userId])
  @@map("chatSessions")
}

model Message {
  id          String       @id @default(uuid())
  sessionId   String
  session     ChatSession  @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  
  role        String       // user | assistant
  content     String
  metadata    Json?        // citations, sources, etc.
  
  createdAt   DateTime     @default(now())
  
  @@index([sessionId])
  @@map("messages")
}

// Assessment flow: testResults row acts as session; these tables extend it
model AssessmentSession {
  id              String   @id @default(uuid())
  userId          String
  assessmentType  String   // big5 | mbti | enneagram | work_style
  startedAt       DateTime @default(now())
  completedAt     DateTime?
  isValid         Boolean  @default(true) // false if 2+ attention checks failed
  testResultId    String?  @unique // link to testResults.id for backward compat

  @@index([userId])
  @@index([assessmentType])
  @@map("assessment_sessions")
}

model ItemResponse {
  id              String   @id @default(uuid())
  sessionId       String   // testResults.id or assessment_sessions.id
  itemId          String
  responseValue   Int      // 1-7 for Likert
  responseTimeMs   Int?
  presentedOrder  Int

  @@index([sessionId])
  @@map("item_responses")
}

model ScaleScore {
  id          String   @id @default(uuid())
  sessionId   String
  scaleName   String
  rawScore    Float    // mean 1-7
  percentile  Float?
  tScore      Float?   // mean=50, SD=10

  @@index([sessionId])
  @@map("scale_scores")
}

model TypeAssignment {
  id                String   @id @default(uuid())
  sessionId         String
  primaryType       String
  secondaryType     String?
  typeClarityIndex  Float?
  fullProfileJson   Json?

  @@index([sessionId])
  @@map("type_assignments")
}

model ValidationMetric {
  id              String   @id @default(uuid())
  assessmentType  String
  metricName      String   // cronbach_alpha | cfa_cfi | cfa_rmsea | test_retest_r
  scaleName       String?
  value           Float
  sampleSize      Int?
  computedAt      DateTime @default(now())

  @@index([assessmentType])
  @@map("validation_metrics")
}

model EsotericProfile {
  id          String   @id @default(uuid())
  userId      String
  framework   String   // western_astro | vedic_astro | numerology | human_design | chinese_zodiac | mayan
  profileJson Json
  computedAt  DateTime @default(now())

  @@index([userId])
  @@index([framework])
  @@map("esoteric_profiles")
}

// Pricing architecture
model UserSubscription {
  id                    String   @id @default(uuid())
  userId                String
  plan                  String   // pro_monthly | pro_annual
  status                String   // active | cancelled | past_due | trialing
  currentPeriodStart     DateTime
  currentPeriodEnd       DateTime
  stripeSubscriptionId  String?  @unique
  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt

  @@index([userId])
  @@map("user_subscriptions")
}

model UserPurchase {
  id               String   @id @default(uuid())
  userId           String
  productType      String   // report | bundle | specialty_report | credit_pack
  productId        String
  pricePaid        Int      // cents
  purchasedAt      DateTime @default(now())
  stripePaymentId  String?

  @@index([userId])
  @@index([userId, productType, productId])
  @@map("user_purchases")
}

model UserMessageCredit {
  id               String    @id @default(uuid())
  userId           String
  creditType       String    // monthly_allowance | rollover | top_up
  creditsRemaining Int       @default(0)
  periodStart      DateTime?
  periodEnd        DateTime?
  createdAt        DateTime  @default(now())

  @@index([userId])
  @@index([userId, creditType])
  @@map("user_message_credits")
}

model UserReport {
  id          String   @id @default(uuid())
  userId      String
  framework   String   // big_five | personality_type | ... | annual_portrait
  unlockedVia String  // purchase | subscription | bundle
  unlockedAt  DateTime @default(now())
  reportData  Json?

  @@unique([userId, framework])
  @@index([userId])
  @@map("user_reports")
}